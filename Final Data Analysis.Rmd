---
title: "Final Data Analysis"
output: pdf_document
date: "2025-05-19"
---

```{r}
# --- Loading Packages ---
library(readr) 
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(VennDiagram)
library(grid)
library(reshape2)
library(visNetwork)
library(data.table)

```

```{r}
# --- Loading Files --
intolerome_path <- "/Users/hassan/Desktop/UCSF Lab Work/CGA App/data/Intolerome.tsv"
ctd_path <- "/Users/hassan/Desktop/UCSF Lab Work/CGA App/data/CTD_chem_gene_ixns.tsv"

intolerome <- read.delim(intolerome_path, sep = "\t")
ctd <- read.delim(ctd_path, skip = 27, sep = "\t")

```

```{r}
#Process the datasets

# Convert ctd to data.table
ctd <- as.data.table(ctd)

# Clean InteractionActions in chunks to avoid memory spikes
chunk_size <- 50000
n <- nrow(ctd)

for (i in seq(1, n, by = chunk_size)) {
  idx <- i:min(i + chunk_size - 1, n)
  ctd[idx, InteractionActions := gsub("\\^", " ", InteractionActions[idx])]
  ctd[idx, InteractionActions := gsub("\\|", "; ", InteractionActions[idx])]
}

# Check memory usage of InteractionActions column
cat("InteractionActions size (MB):", object.size(ctd$InteractionActions) / 1024^2, "\n")

# Convert intolerome to data.table
intolerome <- as.data.table(intolerome)

# Separate Gene.Locus into Gene_Name and Gene_ID
intolerome[, c("Gene_Name", "Gene_ID") := tstrsplit(Gene.Locus, "; id:")]

# Clean Gene_Name and Gene_ID values
intolerome[, Gene_Name := gsub("name: ", "", Gene_Name)]
intolerome[, Gene_ID := as.numeric(gsub(";", "", Gene_ID))]

# Format System.Affected to sentence case
intolerome[, System.Affected := str_to_sentence(System.Affected)]

# Check memory usage of intolerome
cat("Intolerome size (MB):", object.size(intolerome) / 1024^2, "\n")

# Free unused memory
gc()


```


```{r}
# --- Merge Files ---
merged_df <- left_join(intolerome, ctd, by = c("Gene_ID" = "GeneID"), relationship = "many-to-many") %>%
  mutate(
    InteractionActions = str_replace_all(InteractionActions, "\\^", " "),
    InteractionActions = str_replace_all(InteractionActions, "\\|", "; ")
  ) %>%
  filter(Organism == "Homo sapiens")

saveRDS(merged_df, file = "/Users/hassan/Desktop/UCSF Lab Work/CGA App/data/merged_data.rds")

```

```{r}
# --- RPL Genes ---

# Define the genes of interest
genes_of_interest <- c("AURKB", "F2", "F5", "FOXD1", "PADI6")

# Filter the dataframe to include only rows where Gene_Name is in the list
rpl_df <- merged_df[merged_df$Gene_Name %in% genes_of_interest, ]

# Print the extracted rows
print(rpl_df)

write.csv(rpl_df, "/Users/hassan/Desktop/UCSF Lab Work/CGA App/data/rpl_genes.csv", row.names = FALSE)
```

```{r}
# Count the occurrences of each gene
gene_counts <- table(intolerome$Gene_Name)

# Find genes that appear exactly 3 times
repeated_genes <- names(gene_counts[gene_counts == 2])

# Display the repeated genes
cat("Genes that appear exactly 3 times:", repeated_genes, "\n")

# Genes that appear exactly 3 times
repeated_genes <- c("CRPPA", "MMUT", "TBX1")

# Filter the rows where the Gene_Name is one of the repeated genes
filtered_rows <- intolerome[intolerome$Gene_Name %in% repeated_genes, ]

# Print the filtered rows
print(filtered_rows)
```

```{r}
# Filter out F2 from the data
rpl_df_f5 <- rpl_df %>% 
  filter(Gene_Name == "AURKB")

# Extract unique genes and chemicals from the filtered data
unique_genes <- unique(rpl_df_f5$Gene_Name)
unique_chemicals <- unique(rpl_df_f5$X..ChemicalName)

# Create nodes: one node for each unique gene and one for each unique chemical
nodes <- data.frame(
  id    = c(unique_genes, unique_chemicals),
  label = c(unique_genes, unique_chemicals),
  group = c(rep("Gene", length(unique_genes)), rep("Chemical", length(unique_chemicals))),
  stringsAsFactors = FALSE
)

# Create edges for gene-to-chemical interactions
edges <- data.frame(
  from = rpl_df_f5$Gene_Name,
  to   = rpl_df_f5$X..ChemicalName,
  stringsAsFactors = FALSE
)

# Generate the network diagram
visNetwork(nodes, edges) %>%
  visPhysics(stabilization = list(enabled = TRUE, iterations = 500, updateInterval = 25)) %>%
  visNodes(scaling = list(min = 10, max = 30)) %>%
  visEdges(width = 1, color = "gray", arrows = "to") %>%
  visGroups(groupname = "Gene", 
            color = list(background = "lightcoral", border = "lightcoral")) %>%
  visGroups(groupname = "Chemical", 
            color = list(background = "lightseagreen", border = "lightseagreen")) %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE)

```

```{r}
# Function to create bar plot distributions for unique chemicals
plot_distribution_unique_chemicals <- function(data, column_name, title, fill_color = "steelblue", border_color = "black") {
  formatted_column_name <- str_replace_all(column_name, "[._]", " ")
  
  # Correct variants in System.Affected column
  if (column_name == "System.Affected") {
    data <- data %>%
      mutate(!!sym(column_name) := case_when(
        tolower(!!sym(column_name)) %in% c("respiratorya", "resperatory") ~ "Respiratory",
        TRUE ~ as.character(!!sym(column_name))
      ))
  }

  # Count unique chemicals per category
  distribution <- data %>%
    distinct(X..ChemicalName, !!sym(column_name)) %>%
    count(!!sym(column_name), name = "Count") %>%
    arrange(desc(Count))
  
  # Generate bar plot
  ggplot(distribution, aes(x = reorder(!!sym(column_name), -Count), y = Count)) +
    geom_bar(stat = "identity", fill = fill_color, color = border_color) +
    geom_text(aes(label = Count), vjust = -0.3, size = 3) +
    labs(
      title = title,
      x = formatted_column_name,
      y = "Unique Chemical Count"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.title = element_text(hjust = 0.5, face = "bold"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank()
    )
}

# Print dataset summary statistics
cat("\nInitial Merged Dataset Statistics (Homo sapiens):\n")
cat("Total interactions:", nrow(merged_df), "\n")
cat("Total unique chemicals:", n_distinct(merged_df$X..ChemicalName), "\n")
cat("Total unique genes:", n_distinct(merged_df$Gene_ID), "\n\n")

# Generate bar plots based on unique chemicals
p1 <- plot_distribution_unique_chemicals(merged_df, "Gene.Effect", "Distribution of Gene Effect (Unique Chemicals)", fill_color = "lavender", border_color = "black")
p2 <- merged_df %>%
  # 1) normalize: trim & lowercase
  mutate(
    System.Affected = System.Affected %>%
      str_trim() %>%             # remove leading/trailing whitespace
      tolower()                  # bring everything to lower case
  ) %>%
  # 2) recode all variants
  mutate(
    System.Affected = case_when(
      str_detect(System.Affected, "respir") ~ "Respiratory",
      System.Affected %in% c("hematopoetic", "haematopoetic") ~ "Hematopoietic",
      TRUE ~ str_to_sentence(System.Affected)
    )
  ) %>%
  # 3) send the cleaned data into your existing plot function
  plot_distribution_unique_chemicals(
    column_name  = "System.Affected",
    title        = "Distribution of System Affected (Unique Chemicals)",
    fill_color   = "lightcoral",
    border_color = "black"
  )
p3 <- plot_distribution_unique_chemicals(merged_df, "Lethality.Mode.of.Function", "Distribution of Lethality Mode of Function (Unique Chemicals)", fill_color = "lightseagreen", border_color = "black")

# Reshape lethality timing data to long format and count unique chemicals per timepoint
lethality_timing_long <- merged_df %>%
  rename(
    "Trimester 1st" = X1st,
    "Trimester 2nd" = X2nd,
    "Trimester 3rd" = X3rd,
    "Post natal" = Postnatal
  ) %>%
  select(X..ChemicalName, "Trimester 1st", "Trimester 2nd", "Trimester 3rd", "Post natal") %>%
  pivot_longer(cols = -X..ChemicalName, names_to = "Lethality_Timing", values_to = "Presence") %>%
  filter(!is.na(Presence)) %>%
  distinct(X..ChemicalName, Lethality_Timing) %>%
  count(Lethality_Timing, name = "Count")

# Generate bar plot for lethality timing
lethality_timing_long <- merged_df %>%
  rename(
    "Trimester 1st" = X1st,
    "Trimester 2nd" = X2nd,
    "Trimester 3rd" = X3rd,
    "Post natal" = Postnatal
  ) %>%
  select(X..ChemicalName, "Trimester 1st", "Trimester 2nd", "Trimester 3rd", "Post natal") %>%
  pivot_longer(cols = -X..ChemicalName, names_to = "Lethality_Timing", values_to = "Presence") %>%
  filter(Presence == "x") %>%  # Only count when presence is explicitly marked as "x"
  distinct(X..ChemicalName, Lethality_Timing) %>%
  count(Lethality_Timing, name = "Count")

# Generate bar plot for lethality timing
p4 <- ggplot(lethality_timing_long, aes(x = reorder(Lethality_Timing, -Count), y = Count)) +
  geom_bar(stat = "identity", fill = "lightblue", color = "black") +
  geom_text(aes(label = Count), vjust = -0.3, size = 4) +
  labs(
    title = "Distribution of Lethality Timing (Unique Chemicals)",
    x = "Lethality Timing",
    y = "Unique Chemical Count"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

# Display plots
print(p1)
print(p2)
print(p3)
print(p4)


```
```{r}
# Step 1: Clean and reshape lethality timing data
lethality_timing_long <- merged_df %>%
  rename(
    "Trimester 1st" = X1st,
    "Trimester 2nd" = X2nd,
    "Trimester 3rd" = X3rd,
    "Post natal" = Postnatal
  ) %>%
  select(X..ChemicalName, "Trimester 1st", "Trimester 2nd", "Trimester 3rd", "Post natal") %>%
  pivot_longer(cols = -X..ChemicalName, names_to = "Lethality_Timing", values_to = "Presence") %>%
  filter(Presence == "x") %>%
  distinct(X..ChemicalName, Lethality_Timing) %>%
  count(Lethality_Timing, name = "Count") %>%
  mutate(Percentage = round(Count / sum(Count) * 100, 1))  # add percentage column

# Step 2: Create pie chart
p4_pie <- ggplot(lethality_timing_long, aes(x = "", y = Count, fill = Lethality_Timing)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  geom_text(aes(label = paste0(Percentage, "%")),
            position = position_stack(vjust = 0.5), size = 4) +
  labs(
    title = "Lethality Timing Distribution (Unique Chemicals)",
    fill = "Lethality Timing"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# Step 3: Display the pie chart
print(p4_pie)


```

```{r}
# --- RPL Analysis ---

# Loop through each gene and print the number of rows in rpl_data
cat("\n-------Number of Interactions-------\n")
for (gene in genes_of_interest) {
  num_rows <- nrow(rpl_df[rpl_df$Gene_Name == gene, ])
  cat("Gene:", gene, "- Number of rows:", num_rows, "\n")
}
cat("\n-------Unique Chemicals-------\n")
# Loop through each gene and print the number of unique chemicals
for (gene in genes_of_interest) {
  unique_chemicals <- unique(rpl_df$X..ChemicalName[rpl_df$Gene_Name == gene])
  num_unique_chemicals <- length(unique_chemicals)
  cat("Gene:", gene, "- Unique chemicals:", num_unique_chemicals, "\n")
}


```

```

```{r}
# Extract all chemicals associated with each gene dynamically
chemical_data <- split(rpl_df$X..ChemicalName, rpl_df$Gene_Name)

# Convert each list element to a unique set
chemical_data <- lapply(chemical_data, unique)

# Print number of chemicals per gene
sapply(chemical_data, length)

# Function to calculate set intersections
calc_intersection <- function(...) {
  Reduce(intersect, list(...))
}

# List of genes
genes <- names(chemical_data)

# Generate all possible gene intersections
intersection_counts <- list()

for (i in 1:length(genes)) {
  for (j in (i+1):length(genes)) {
    intersection_counts[[paste(genes[i], genes[j], sep="_")]] <- length(intersect(chemical_data[[genes[i]]], chemical_data[[genes[j]]]))
  }
}

# Print all computed intersections
print(intersection_counts)

# Create empty matrix
overlap_matrix <- matrix(0, nrow = length(genes), ncol = length(genes))
rownames(overlap_matrix) <- genes
colnames(overlap_matrix) <- genes

# Fill matrix with intersection counts
for (i in 1:length(genes)) {
  for (j in 1:length(genes)) {
    overlap_matrix[i, j] <- length(intersect(chemical_data[[genes[i]]], chemical_data[[genes[j]]]))
  }
}

# Print the 5x5 overlap matrix
print(overlap_matrix)

```

```{r}
# Compute all required pairwise, triple, quadruple, and quintuple intersections
n12 <- length(intersect(chemical_data[[genes[1]]], chemical_data[[genes[2]]]))
n13 <- length(intersect(chemical_data[[genes[1]]], chemical_data[[genes[3]]]))
n14 <- length(intersect(chemical_data[[genes[1]]], chemical_data[[genes[4]]]))
n15 <- length(intersect(chemical_data[[genes[1]]], chemical_data[[genes[5]]]))
n23 <- length(intersect(chemical_data[[genes[2]]], chemical_data[[genes[3]]]))
n24 <- length(intersect(chemical_data[[genes[2]]], chemical_data[[genes[4]]]))
n25 <- length(intersect(chemical_data[[genes[2]]], chemical_data[[genes[5]]]))
n34 <- length(intersect(chemical_data[[genes[3]]], chemical_data[[genes[4]]]))
n35 <- length(intersect(chemical_data[[genes[3]]], chemical_data[[genes[5]]]))
n45 <- length(intersect(chemical_data[[genes[4]]], chemical_data[[genes[5]]]))

# Triple intersections
n123 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[2]]], chemical_data[[genes[3]]])))
n124 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[2]]], chemical_data[[genes[4]]])))
n125 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[2]]], chemical_data[[genes[5]]])))
n134 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[3]]], chemical_data[[genes[4]]])))
n135 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[3]]], chemical_data[[genes[5]]])))
n145 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[4]]], chemical_data[[genes[5]]])))
n234 <- length(Reduce(intersect, list(chemical_data[[genes[2]]], chemical_data[[genes[3]]], chemical_data[[genes[4]]])))
n235 <- length(Reduce(intersect, list(chemical_data[[genes[2]]], chemical_data[[genes[3]]], chemical_data[[genes[5]]])))
n245 <- length(Reduce(intersect, list(chemical_data[[genes[2]]], chemical_data[[genes[4]]], chemical_data[[genes[5]]])))
n345 <- length(Reduce(intersect, list(chemical_data[[genes[3]]], chemical_data[[genes[4]]], chemical_data[[genes[5]]])))

# Quadruple intersections
n1234 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[2]]], chemical_data[[genes[3]]], chemical_data[[genes[4]]])))
n1235 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[2]]], chemical_data[[genes[3]]], chemical_data[[genes[5]]])))
n1245 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[2]]], chemical_data[[genes[4]]], chemical_data[[genes[5]]])))
n1345 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[3]]], chemical_data[[genes[4]]], chemical_data[[genes[5]]])))
n2345 <- length(Reduce(intersect, list(chemical_data[[genes[2]]], chemical_data[[genes[3]]], chemical_data[[genes[4]]], chemical_data[[genes[5]]])))

# Quintuple intersection (ALL 5 genes)
n12345 <- length(Reduce(intersect, list(chemical_data[[genes[1]]], chemical_data[[genes[2]]], chemical_data[[genes[3]]], chemical_data[[genes[4]]], chemical_data[[genes[5]]])))

# Print to debug if needed
cat("n12345 (all genes):", n12345, "\n")

# Draw the Venn diagram with all calculated intersections
venn.plot <- draw.quintuple.venn(
  area1 = length(chemical_data[[genes[1]]]),
  area2 = length(chemical_data[[genes[2]]]),
  area3 = length(chemical_data[[genes[3]]]),
  area4 = length(chemical_data[[genes[4]]]),
  area5 = length(chemical_data[[genes[5]]]),
  n12 = n12, n13 = n13, n14 = n14, n15 = n15,
  n23 = n23, n24 = n24, n25 = n25,
  n34 = n34, n35 = n35, n45 = n45,
  n123 = n123, n124 = n124, n125 = n125,
  n134 = n134, n135 = n135, n145 = n145,
  n234 = n234, n235 = n235, n245 = n245,
  n345 = n345,
  n1234 = n1234, n1235 = n1235, n1245 = n1245, 
  n1345 = n1345, n2345 = n2345, n12345 = n12345,
  category = genes,
  fill = c("lightcoral","lightblue", "lightseagreen", "lightyellow", "lavender"),
  cat.cex = 2.2,
  cex = 2.5,
  margin = 0.1
)

# Save the Venn diagram
png(filename = "/Users/hassan/Desktop/UCSF Lab Work/CGA App/venn_diagram.png", width = 1000, height = 1000)
grid.draw(venn.plot)
dev.off()

```
```{r}
# Find the intersection of chemicals associated with the five genes
common_chemicals <- Reduce(intersect, list(
  chemical_data[[genes[1]]], 
  chemical_data[[genes[2]]], 
  chemical_data[[genes[3]]], 
  chemical_data[[genes[4]]], 
  chemical_data[[genes[5]]]
))

# Print the common chemicals
print(common_chemicals)


```


```{r}

# Pivot lethality timing data for heatmap
lethality_matrix <- rpl_df %>%
  rename(
    "Trimester 1st" = X1st,
    "Trimester 2nd" = X2nd,
    "Trimester 3rd" = X3rd,
    "Post natal" = Postnatal
  ) %>%
  select(Gene_Name, "Trimester 1st", "Trimester 2nd", "Trimester 3rd", "Post natal") %>%
  pivot_longer(cols = -Gene_Name, names_to = "Lethality_Timing", values_to = "Presence") %>%
  filter(!is.na(Presence) & Presence != "") %>%
  count(Gene_Name, Lethality_Timing) %>%
  spread(Lethality_Timing, n, fill = 0)  # Convert to wide format

# Convert to matrix for heatmap
heatmap_matrix <- as.matrix(lethality_matrix[,-1])
rownames(heatmap_matrix) <- lethality_matrix$Gene_Name

# Plot heatmap
library(pheatmap)
heatmap_matrix_sqrt <- sqrt(heatmap_matrix)

pheatmap(heatmap_matrix_sqrt, 
         main = "Lethality Timing Across RPL Genes", 
         color = colorRampPalette(c("white", "lightseagreen"))(50))

```

```{r}

# Count top 20 chemicals
chemicals <- rpl_df %>%
  count(X..ChemicalName, sort = TRUE) %>%
  top_n(20)  # Select top 20 chemicals

# Remove the 15th ranked chemical
chemicals <- chemicals[-15, ]  # Drops the 15th row due to character length not fitting in

# Adjust font size and plot dimensions
p <- ggplot(chemicals, aes(x = reorder(X..ChemicalName, n), y = n)) +
  geom_bar(stat = "identity", fill = "lightseagreen") +
  coord_flip() +
  labs(title = "Top 20 Chemicals For RPL Genes",
       x = "Chemical Name",
       y = "Number of Interactions ") +
  scale_y_continuous(limits = c(0, 12), breaks = seq(0, 12, by = 2)) +
  theme_minimal() +
  theme(
    plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 8),
    plot.title = element_text(size = 14, face = "bold"),
    panel.grid = element_blank()      # Remove grid lines

  )
print(p)
```

```{r}

# Filter out F2 from the data

# Extract unique genes and chemicals from the filtered data
unique_genes <- unique(rpl_df$Gene_Name)
unique_chemicals <- unique(rpl_df$X..ChemicalName)

# Create nodes: one node for each unique gene and one for each unique chemical
nodes <- data.frame(
  id    = c(unique_genes, unique_chemicals),
  label = c(unique_genes, unique_chemicals),
  group = c(rep("Gene", length(unique_genes)), rep("Chemical", length(unique_chemicals))),
  stringsAsFactors = FALSE
)

# Create edges for gene-to-chemical interactions
edges <- data.frame(
  from = rpl_df$Gene_Name,
  to   = rpl_df$X..ChemicalName,
  stringsAsFactors = FALSE
)

# Generate the network diagram
visNetwork(nodes, edges) %>%
  visPhysics(stabilization = list(enabled = TRUE, iterations = 500, updateInterval = 25)) %>%
  visNodes(scaling = list(min = 10, max = 30)) %>%
  visEdges(width = 1, color = "gray", arrows = "to") %>%
  visGroups(groupname = "Gene", 
            color = list(background = "lightcoral", border = "lightcoral")) %>%
  visGroups(groupname = "Chemical", 
            color = list(background = "lightseagreen", border = "lightseagreen")) %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE)

```

```{r}

# Filter rows so only Gene_Name == "F5"
rpl_df_f5 <- rpl_df %>% 
  filter(Gene_Name == "f5")

# Extract unique genes and chemicals from the filtered data
unique_genes <- unique(rpl_df_f5$Gene_Name)
unique_chemicals <- unique(rpl_df_f5$X..ChemicalName)

# Create nodes: one node for each unique gene and one for each unique chemical
nodes <- data.frame(
  id    = c(unique_genes, unique_chemicals),
  label = c(unique_genes, unique_chemicals),
  group = c(rep("Gene", length(unique_genes)), 
            rep("Chemical", length(unique_chemicals))),
  stringsAsFactors = FALSE
)

# Create edges for gene-to-chemical interactions
edges <- data.frame(
  from = rpl_df_f5$Gene_Name,
  to   = rpl_df_f5$X..ChemicalName,
  stringsAsFactors = FALSE
)

# Generate the network diagram
visNetwork(nodes, edges) %>%
  visPhysics(stabilization = list(enabled = TRUE, iterations = 500, updateInterval = 25)) %>%
  visNodes(scaling = list(min = 10, max = 30)) %>%
  visEdges(width = 1, color = "gray", arrows = "to") %>%
  visGroups(groupname = "Gene", 
            color = list(background = "lightcoral", border = "lightcoral")) %>%
  visGroups(groupname = "Chemical", 
            color = list(background = "lightseagreen", border = "lightseagreen")) %>%
  visOptions(highlightNearest = TRUE, nodesIdSelection = TRUE)

```

```{r}
# ------- KEGG Pathway Analysis for 2 common genes ---------

# Installing packages
# Step 1: Install BiocManager if you haven't already
#if (!requireNamespace("BiocManager", quietly = TRUE))
    #install.packages("BiocManager")

# Step 2: Use BiocManager to install the bioinformatics packages
#BiocManager::install(c("clusterProfiler", "org.Hs.eg.db", "DOSE"))

```
```{r}
#install.packages("circlize")
library(circlize)

# Define pastel color palette
pastel_colors <- colorRampPalette(c("#FBB4AE", "#B3CDE3", "#CCEBC5", "#DECBE4", "#FED9A6", 
                                    "#FFFFCC", "#E5D8BD", "#FDDAEC", "#F2F2F2", "#D9F0A3"))

# Generate enough unique pastel colors
all_labels <- c(rownames(chord_mat), colnames(chord_mat))
color_vector <- setNames(pastel_colors(length(all_labels)), all_labels)

# Clear previous plot
circos.clear()
circos.par(
  gap.after = c(rep(2, nrow(chord_mat) - 1), 10, rep(2, ncol(chord_mat) - 1), 10), 
  track.margin = c(0.01, 0.01),
  track.height = 0.05,
  cell.padding = c(0.01, 0.01, 0.01, 0.01),
  canvas.xlim = c(-3, 2),
  canvas.ylim = c(-3.1, 1.2)
)

# Chord diagram with pastel colors
chordDiagram(
  chord_mat,
  annotationTrack = "grid",
  preAllocateTracks = list(track.height = 0.05),
  transparency = 0.01,
  grid.col = color_vector,
  annotationTrackHeight = c(0.01, 0.03)
)

# Smaller font for labels
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  circos.text(
    CELL_META$xcenter, 
    CELL_META$ylim[1] + mm_y(2), 
    CELL_META$sector.index, 
    facing = "clockwise", 
    niceFacing = TRUE,
    adj = c(0, 0.5),
    cex = 0.7  # Adjust font size
  )
}, bg.border = NA)



```
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggthemes)
library(circlize)
library(stringr)

# Step 1: Filter and clean the data
mechanistic_df <- rpl_df %>%
  filter(X..ChemicalName == "Benzo(a)pyrene") %>% #switch between Benzo(a)pyrene and bisphenol A
  select(Gene_Name, InteractionActions) %>%
  distinct() %>%
  separate_rows(InteractionActions, sep = ";\\s*") %>%
  filter(InteractionActions != "") %>%
  mutate(InteractionActions = str_to_sentence(InteractionActions))

# Step 2: Create the chord matrix
chord_df <- mechanistic_df %>%
  count(Gene_Name, InteractionActions) %>%
  pivot_wider(names_from = InteractionActions, values_from = n, values_fill = 0)

chord_mat <- as.matrix(chord_df[,-1])
rownames(chord_mat) <- chord_df$Gene_Name

# Step 3: Generate pastel colors
all_labels <- c(rownames(chord_mat), colnames(chord_mat))
pastel_colors <- colorRampPalette(c("#FBB4AE", "#B3CDE3", "#CCEBC5", "#DECBE4", "#FED9A6", 
                                    "#FFFFCC", "#E5D8BD", "#FDDAEC", "#F2F2F2", "#D9F0A3"))
color_vector <- setNames(pastel_colors(length(all_labels)), all_labels)

# Step 4: Draw the chord diagram
circos.clear()
circos.par(
  gap.after = c(rep(2, nrow(chord_mat) - 1), 10, rep(2, ncol(chord_mat) - 1), 10), 
  track.margin = c(0.01, 0.01),
  track.height = 0.05,
  cell.padding = c(0.01, 0.01, 0.01, 0.01),
  canvas.xlim = c(-3, 2),
  canvas.ylim = c(-3.1, 3)
)

chordDiagram(
  chord_mat,
  annotationTrack = "grid",
  preAllocateTracks = list(track.height = 0.05),
  transparency = 0.001,
  grid.col = color_vector,
  annotationTrackHeight = c(0.01, 0.03)
)

# Step 5: Label sectors (no chemical name shown)
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  circos.text(
    CELL_META$xcenter, 
    CELL_META$ylim[1] + mm_y(2), 
    CELL_META$sector.index, 
    facing = "clockwise", 
    niceFacing = TRUE,
    adj = c(0, 0.5),
    cex = 0.7
  )
}, bg.border = NA)

```

```{r}
# ------ Reactome Pathway Enrichment------

#if (!requireNamespace("ReactomePA", quietly = TRUE)) {
  #BiocManager::install("ReactomePA")
#}
library(ReactomePA)
library(clusterProfiler)
library(org.Hs.eg.db)

```

```{r}
# Filter rpl_df for BPA and B[a]P
chem_subset <- rpl_df %>%
  filter(X..ChemicalName %in% c("bisphenol A")) #switch between Benzo(a)pyrene and bisphenol A

# Get unique gene symbols that are associated with those chemicals
chem_genes <- unique(chem_subset$Gene_Name)

# Convert those to Entrez IDs
chem_entrez_df <- bitr(chem_genes,
                       fromType = "SYMBOL",
                       toType = "ENTREZID",
                       OrgDb = org.Hs.eg.db)

# Run Reactome enrichment just on these genes
reactome_chem_results <- enrichPathway(gene = chem_entrez_df$ENTREZID,
                                       organism = "human",
                                       pvalueCutoff = 0.1,
                                       readable = TRUE)

# Visualize
# Barplot with expanded margins
# Set number of categories to 20+
barplot(reactome_chem_results, showCategory = 10, title = "Reactome Enrichment (BPA & B[a]P Genes)") +
  theme(
    plot.margin = margin(t = 10, r = 20, b = 10, l = 20),  # increase left margin
    axis.text.y = element_text(size = 6, hjust = 1)
# smaller y-axis text
  )

```